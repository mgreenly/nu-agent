name: Coverage

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: false

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Setup development environment
        run: bin/setup

      - name: Setup test API keys
        run: |
          mkdir -p $HOME/.secrets
          echo "test-anthropic-key" > $HOME/.secrets/ANTHROPIC_API_KEY
          echo "test-openai-key" > $HOME/.secrets/OPENAI_API_KEY
          echo "test-gemini-key" > $HOME/.secrets/GEMINI_API_KEY
          echo "test-xai-key" > $HOME/.secrets/XAI_API_KEY

      - name: Run tests with coverage reporting
        env:
          TEST_DB_PATH: ${{ github.workspace }}/db/test.db  # Use file-based database for consistency
          CORES: 1  # Run tests sequentially, not in parallel
        # Note: We use 'coverage' instead of 'coverage:enforce' because CI environments
        # lack TTY support, which causes ~9 lines and ~7 branches of TTY-dependent code
        # to not be covered. Coverage enforcement should be done in local development
        # where full TTY support is available (99.96% line, 99.27% branch).
        run: bundle exec rake coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
